<?php

namespace Drupal\htm_custom_event_registration\Plugin\GraphQL\Mutations;

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityTypeManagerInterface;
use Drupal\graphql\GraphQL\Execution\ResolveContext;
use Drupal\graphql_core\Plugin\GraphQL\Mutations\Entity\CreateEntityBase;
use GraphQL\Type\Definition\ResolveInfo;
use Symfony\Component\DependencyInjection\ContainerInterface;

use Drupal\custom_graphql_functions\Language\CustomGraphqlLanguageNegotiator;
use Drupal\Core\Language\LanguageManager;

/**
 * Simple mutation for creating a new article node.
 *
 * @GraphQLMutation(
 *   id = "create_event_reg",
 *   entity_type = "event_reg_entity",
 *   secure = true,
 *   name = "createEventRegistration",
 *   type = "EntityCrudOutput!",
 *   arguments = {
 *     "input" = "EventInput",
 * 		 "language" = "LanguageId!"
 *   }
 * )
 */
class CreateEventRegistration extends CreateEntityBase{

	/**
	 * The entity type manager.
	 *
	 * @var \Drupal\Core\Entity\EntityTypeManagerInterface
	 */
	protected $entityTypeManager;

	/**
	 * The Custom Language Negotiator.
	 *
	 * @var \Drupal\custom_graphql_functions\Language\CustomGraphqlLanguageNegotiator
	 */
	protected $CustomGraphqlLanguageNegotiator;

	/**
	 * @inheritDoc
	 */
	public static function create(ContainerInterface $container, array $configuration, $pluginId, $pluginDefinition)
	{
		return new static(
			$configuration,
			$pluginId,
			$pluginDefinition,
			$container->get('entity_type.manager'),
			$container->get('custom_graphql_functions.language_negotiator'),
			$container->get('language_manager'));
	}

	/**
	 * @inheritDoc
	 */
	public function __construct(
		array $configuration,
		$pluginId,
		$pluginDefinition,
		EntityTypeManagerInterface $entityTypeManager,
		CustomGraphqlLanguageNegotiator $CustomGraphqlLanguageNegotiator,
		LanguageManager $languageManager)
	{
		parent::__construct($configuration, $pluginId, $pluginDefinition, $entityTypeManager);
		$this->CustomGraphqlLanguageNegotiator = $CustomGraphqlLanguageNegotiator;
		$this->languageManager = $languageManager;
	}


	/**
	 * @param $value
	 * @param array $args
	 * @param ResolveContext $context
	 * @param ResolveInfo $info
	 * @return array
	 */
	protected function extractEntityInput($value, array $args, ResolveContext $context, ResolveInfo $info){
		return [
			'name' => $args['input']['first_name'] . ' ' . $args['input']['last_name'],
			'event_reference' => $args['input']['event_id'],
			'language' => $context->getContext('language', $info),
			'participant_first_name' => $args['input']['first_name'],
			'participant_last_name' => $args['input']['last_name'],
			'participant_organization' => isset($args['input']['organization']) ? $args['input']['organization'] : '',
			'participant_email' => $args['input']['email'],
			'participant_phone' => isset($args['input']['phone']) ? $args['input']['phone'] : '',
			'participant_idcode' => isset($args['input']['id_code']) ? $args['input']['id_code'] : '',
			'participant_comment' => isset($args['input']['comment']) ? $args['input']['comment'] : '',
		];
	}

	/**
	 * @inheritDoc
	 */
	public function resolve($value, array $args, ResolveContext $context, ResolveInfo $info)
	{
		$this->languageManager->setNegotiator($this->CustomGraphqlLanguageNegotiator);
		//dump($args);
		// Set new language by its langcode.
		// Needed to re-run language negotiation.
		$this->languageManager->reset();
		$this->languageManager->getNegotiator()->setLanguageCode($args['language']);

		$context->setContext('language', $args['language'], $info);

		return parent::resolve($value, $args, $context, $info); // TODO: Change the autogenerated stub
	}

}