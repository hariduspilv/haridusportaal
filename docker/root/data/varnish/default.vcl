vcl 4.0;

acl upstream_proxy {
    "swag";
}

# Default backend definition. Set this to point to your content server.
backend default {
    .host = "drupal";
    .port = "80";
}

sub vcl_recv {

    if (req.method == "PURGE") {
        return (purge);
    }

    if (!req.http.Access-Control-Allow-Origin){
	    return (pass);
    }

    # Set the X-Forwarded-For header so the backend can see the original
    # IP address. If one is already set by an upstream proxy, we'll just re-use that.
    if (client.ip ~ upstream_proxy && req.http.X-Forwarded-For) {
       set req.http.X-Forwarded-For = req.http.X-Forwarded-For;
    } else {
       set req.http.X-Forwarded-For = regsub(client.ip, ":.*", "");
    }

    if (req.http.Cookie !~ "SESS") {
        unset req.http.Cookie;
    }

    ## Remove has_js and Google Analytics cookies.
    set req.http.Cookie = regsuball(req.http.Cookie, "(^|;\s*)(__[a-z]+|has_js|cookie-agreed|MCPopupClosed)=[^;]*", "");
    ## Remove a .;. prefix, if present.
    set req.http.Cookie = regsub(req.http.Cookie, "^;\s*", "");
    ## Remove empty cookies.
    if (req.http.Cookie ~ "^\s*$") {
       unset req.http.Cookie;
    }
    # Site still uses some static files out of /files, cache them
    if (req.url ~ "^/files/site.*") {
       unset req.http.Cookie;
    }
    # enable caching of theme files
    if (req.url ~ "^/sites/www.site.*") {
       unset req.http.Cookie;
    }
    # Drupal js/css doesn.t need cookies, cache them
    if (req.url ~ "^/modules/.*\.(js|css)\?") {
       unset req.http.Cookie;
    }
    ## Pass cron jobs and server-status
    if (req.url ~ ".*/server-status$") {
       return (pass);
    }
    if (req.url ~ "^/update\.php" ||
    	req.url ~ "^/cron\.php" ||
	    req.url ~ "^/install\.php" ||
    	req.url ~ "^/admin" ||
    	req.url ~ "^/admin/.*$" ||
    	req.url ~ "^/user" ||
    	req.url ~ "^/user/.*$" ||
    	req.url ~ "^/users/.*$" ||
    	req.url ~ "^/info/.*$" ||
    	req.url ~ "^/flag/.*$" ||
    	req.url ~ "^.*/ajax/.*$" ||
    	req.url ~ "^.*/node/.*$" ||
	    req.url ~ "^.*customFavorites.*$" ||
    	req.url ~ "^/system/files/.*$" ||
      req.url ~ "^/default/files/.*$" ||
      req.url ~ "^/custom/login/.*$" ||
      req.url ~ "^/dashboard/.*$") {
        return (pass);
    }
}
 
sub vcl_hash {
   if (req.http.Cookie) {
      hash_data(req.http.Cookie);
   }
}

sub vcl_synth {
   set resp.http.Content-Type = "text/html; charset=utf-8";
   set resp.http.Retry-After = "5";
   synthetic( {"<!DOCTYPE html>
   <html>
      <head>
         <title>503</title>
         <style>
            body {
               font-family: Helvetica, Arial, sans-serif;
               background-color: #ffffff;
            }
            .message {
               padding: 20px 40px;
               margin: 0 auto;
               color: #2e3374;
               align-items: center;
               text-align: center;
            }
            center {
               margin: 40px 0;
            }
            h1 {
               font-size: 28px;
               line-height: 26px;
            }
            h2 {
               font-size: 18px;
               line-height: 26px;
            }
            p {
               font-size: 12px;
            }
            a {
               color: rgb(207, 48, 139);
            }
            svg {
               display: flex;
               align-items: center;
               width: 100%;
               margin: 2rem 0 0;
            }
         </style>
      </head>
      <body>
         <svg width="91" height="20" viewBox="0 0 91 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
               d="M33.9798 15.2001C32.3798 15.2001 31.1198 14.7667 30.1998 13.9C29.2798 13.0334 28.7998 11.7734 28.7598 10.12V9.42005C28.8131 7.84672 29.2998 6.62005 30.2198 5.74005C31.1531 4.84672 32.3998 4.40005 33.9598 4.40005C35.0931 4.40005 36.0464 4.63338 36.8198 5.10005C37.6064 5.55338 38.1931 6.18005 38.5798 6.98005C38.9798 7.78005 39.1798 8.70005 39.1798 9.74005V10.22C39.1798 10.3534 39.1331 10.4734 39.0398 10.58C38.9464 10.6734 38.8264 10.72 38.6798 10.72H32.2798V10.86C32.3064 11.4867 32.4598 11.9934 32.7398 12.38C33.0198 12.7667 33.4264 12.96 33.9598 12.96C34.2931 12.96 34.5664 12.8934 34.7798 12.76C34.9931 12.6134 35.1864 12.44 35.3598 12.24C35.4798 12.0934 35.5731 12.0067 35.6398 11.98C35.7198 11.94 35.8398 11.92 35.9998 11.92H38.4798C38.5998 11.92 38.6998 11.9601 38.7798 12.0401C38.8731 12.1067 38.9198 12.2 38.9198 12.32C38.9198 12.6667 38.7198 13.0667 38.3198 13.5201C37.9331 13.9734 37.3664 14.3667 36.6198 14.7001C35.8731 15.0334 34.9931 15.2001 33.9798 15.2001ZM35.6598 8.74005V8.70005C35.6598 8.04672 35.5064 7.53338 35.1998 7.16005C34.9064 6.77338 34.4931 6.58005 33.9598 6.58005C33.4398 6.58005 33.0264 6.77338 32.7198 7.16005C32.4264 7.53338 32.2798 8.04672 32.2798 8.70005V8.74005H35.6598Z"
               fill="#2E3374" />
            <path
               d="M44.9348 15.2001C43.6281 15.2001 42.6081 14.7934 41.8748 13.98C41.1548 13.1534 40.7614 11.9934 40.6948 10.5L40.6748 9.80005L40.6948 9.08005C40.7481 7.64005 41.1414 6.50005 41.8748 5.66005C42.6214 4.82005 43.6414 4.40005 44.9348 4.40005C46.1481 4.40005 47.1281 4.79338 47.8748 5.58005V1.30005C47.8748 1.15338 47.9214 1.03338 48.0148 0.940049C48.1081 0.846715 48.2281 0.800049 48.3748 0.800049H50.8148C50.9614 0.800049 51.0814 0.846715 51.1748 0.940049C51.2681 1.03338 51.3148 1.15338 51.3148 1.30005V14.5C51.3148 14.6334 51.2681 14.7534 51.1748 14.8601C51.0814 14.9534 50.9614 15 50.8148 15H48.5548C48.4214 15 48.3014 14.9534 48.1948 14.8601C48.1014 14.7534 48.0548 14.6334 48.0548 14.5V13.8601C47.3214 14.7534 46.2814 15.2001 44.9348 15.2001ZM46.0348 12.5201C46.6348 12.5201 47.0814 12.3334 47.3748 11.96C47.6681 11.5734 47.8348 11.08 47.8748 10.48C47.8881 10.3067 47.8948 10.0534 47.8948 9.72005C47.8948 9.40005 47.8881 9.15338 47.8748 8.98005C47.8481 8.43338 47.6814 7.98005 47.3748 7.62005C47.0681 7.26005 46.6214 7.08005 46.0348 7.08005C45.4081 7.08005 44.9548 7.26672 44.6748 7.64005C44.4081 8.01338 44.2548 8.52672 44.2148 9.18005C44.2014 9.31338 44.1948 9.52005 44.1948 9.80005C44.1948 10.08 44.2014 10.2867 44.2148 10.42C44.2548 11.0734 44.4081 11.5867 44.6748 11.96C44.9548 12.3334 45.4081 12.5201 46.0348 12.5201Z"
               fill="#2E3374" />
            <path
               d="M57.492 15.2001C56.3186 15.2001 55.372 14.8067 54.652 14.0201C53.932 13.2201 53.572 12.1067 53.572 10.68V5.10005C53.572 4.95338 53.6186 4.83338 53.712 4.74005C53.8053 4.64672 53.9253 4.60005 54.072 4.60005H56.572C56.7186 4.60005 56.8386 4.64672 56.932 4.74005C57.0386 4.83338 57.092 4.95338 57.092 5.10005V10.56C57.092 11.8667 57.672 12.5201 58.832 12.5201C59.392 12.5201 59.832 12.3467 60.152 12C60.472 11.6534 60.632 11.1734 60.632 10.56V5.10005C60.632 4.95338 60.6786 4.83338 60.772 4.74005C60.8786 4.64672 60.9986 4.60005 61.132 4.60005H63.632C63.7786 4.60005 63.8986 4.64672 63.992 4.74005C64.0853 4.83338 64.132 4.95338 64.132 5.10005V14.5C64.132 14.6334 64.0853 14.7534 63.992 14.8601C63.8986 14.9534 63.7786 15 63.632 15H61.312C61.1786 15 61.0586 14.9534 60.952 14.8601C60.8586 14.7534 60.812 14.6334 60.812 14.5V13.74C60.1186 14.7134 59.012 15.2001 57.492 15.2001Z"
               fill="#2E3374" />
            <path
               d="M67.4 15.0001C67.2666 15.0001 67.16 14.9601 67.08 14.8801C67 14.8001 66.96 14.6935 66.96 14.5601V13.6001C66.96 13.4668 67 13.3601 67.08 13.2801C67.16 13.1868 67.2666 13.1401 67.4 13.1401H68.36C68.4933 13.1401 68.6 13.1868 68.68 13.2801C68.7733 13.3601 68.82 13.4668 68.82 13.6001V14.5601C68.82 14.6935 68.7733 14.8001 68.68 14.8801C68.6 14.9601 68.4933 15.0001 68.36 15.0001H67.4Z"
               fill="#2E3374" />
            <path
               d="M75.5112 15.2001C74.2445 15.2001 73.2245 14.7868 72.4512 13.9601C71.6779 13.1201 71.2379 12.0001 71.1312 10.6001L71.1112 9.80015L71.1312 9.00015C71.2379 7.61348 71.6712 6.50015 72.4312 5.66015C73.2045 4.82015 74.2312 4.40015 75.5112 4.40015C76.8979 4.40015 77.9779 4.86015 78.7512 5.78015C79.5379 6.70015 79.9312 7.96015 79.9312 9.56015V9.86015C79.9312 9.99348 79.8845 10.1001 79.7912 10.1801C79.7112 10.2601 79.6045 10.3001 79.4712 10.3001H72.3512V10.5001C72.3779 11.1268 72.5179 11.7135 72.7712 12.2601C73.0379 12.7935 73.4045 13.2268 73.8712 13.5601C74.3379 13.8801 74.8845 14.0401 75.5112 14.0401C76.2445 14.0401 76.8379 13.9001 77.2912 13.6201C77.7579 13.3268 78.0912 13.0335 78.2912 12.7401C78.4112 12.5801 78.4979 12.4801 78.5512 12.4401C78.6179 12.4001 78.7312 12.3801 78.8912 12.3801H79.2112C79.3312 12.3801 79.4312 12.4135 79.5112 12.4801C79.5912 12.5468 79.6312 12.6335 79.6312 12.7401C79.6312 13.0201 79.4512 13.3601 79.0912 13.7601C78.7445 14.1468 78.2579 14.4868 77.6312 14.7801C77.0045 15.0601 76.2979 15.2001 75.5112 15.2001ZM78.7112 9.18015V9.10015C78.7112 8.07348 78.4179 7.22681 77.8312 6.56015C77.2579 5.89348 76.4845 5.56015 75.5112 5.56015C74.5379 5.56015 73.7645 5.89348 73.1912 6.56015C72.6312 7.22681 72.3512 8.07348 72.3512 9.10015V9.18015H78.7112Z"
               fill="#2E3374" />
            <path
               d="M86.4292 15.2001C85.1625 15.2001 84.1425 14.7868 83.3692 13.9601C82.5958 13.1201 82.1558 12.0001 82.0492 10.6001L82.0292 9.80015L82.0492 9.00015C82.1558 7.61348 82.5892 6.50015 83.3492 5.66015C84.1225 4.82015 85.1492 4.40015 86.4292 4.40015C87.8158 4.40015 88.8958 4.86015 89.6692 5.78015C90.4558 6.70015 90.8492 7.96015 90.8492 9.56015V9.86015C90.8492 9.99348 90.8025 10.1001 90.7092 10.1801C90.6292 10.2601 90.5225 10.3001 90.3892 10.3001H83.2692V10.5001C83.2958 11.1268 83.4358 11.7135 83.6892 12.2601C83.9558 12.7935 84.3225 13.2268 84.7892 13.5601C85.2558 13.8801 85.8025 14.0401 86.4292 14.0401C87.1625 14.0401 87.7558 13.9001 88.2092 13.6201C88.6758 13.3268 89.0092 13.0335 89.2092 12.7401C89.3292 12.5801 89.4158 12.4801 89.4692 12.4401C89.5358 12.4001 89.6492 12.3801 89.8092 12.3801H90.1292C90.2492 12.3801 90.3492 12.4135 90.4292 12.4801C90.5092 12.5468 90.5492 12.6335 90.5492 12.7401C90.5492 13.0201 90.3692 13.3601 90.0092 13.7601C89.6625 14.1468 89.1758 14.4868 88.5492 14.7801C87.9225 15.0601 87.2158 15.2001 86.4292 15.2001ZM89.6292 9.18015V9.10015C89.6292 8.07348 89.3358 7.22681 88.7492 6.56015C88.1758 5.89348 87.4025 5.56015 86.4292 5.56015C85.4558 5.56015 84.6825 5.89348 84.1092 6.56015C83.5492 7.22681 83.2692 8.07348 83.2692 9.10015V9.18015H89.6292Z"
               fill="#2E3374" />
            <path d="M3 7C4.65685 7 6 5.65685 6 4C6 2.34315 4.65685 1 3 1C1.34315 1 0 2.34315 0 4C0 5.65685 1.34315 7 3 7Z"
               fill="#2E3374" />
            <path
               d="M9 20C11.2091 20 13 18.2091 13 16C13 13.7909 11.2091 12 9 12C6.79086 12 5 13.7909 5 16C5 18.2091 6.79086 20 9 20Z"
               fill="#2E3374" />
            <path
               d="M17 10C18.6569 10 20 8.65685 20 7C20 5.34315 18.6569 4 17 4C15.3431 4 14 5.34315 14 7C14 8.65685 15.3431 10 17 10Z"
               fill="#2E3374" />
         </svg>
         <div class="message">
            <h1>Ei saa rakendusega ühendust</h1>
            <p>Rakendus uueneb või on midagi läinud valesti, proovi hetke pärast uuesti.</p>
            <p>Probleemide jätkumise korral kontakteeru <a target="_blank"
               href="mailto:madis.pold@twn.ee">madis.pold@twn.ee</a>.</p>
         </div>
      </body>
   </html>
   "} );
   return (deliver);
}
