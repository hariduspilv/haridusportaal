<breadcrumbs></breadcrumbs>
<div class="sm-show text-right filter-control">
  <a href="javascript:void(0);" (click)="showFilter = !showFilter">
    <span *ngIf="!showFilter">{{ 'button.filter' | translate }}</span>
    <span *ngIf="showFilter">{{ 'button.filter_close' | translate }}</span>
  </a> 
</div>
<form (submit)="filterSubmit($event)" class="filter-wrapper" [class.filtersActive]="showFilter">
  <div class="main-container">
    <div class="row">
      <div class="col-3 sm-12">
        <div class="round-input__wrapper" [class.complete]="filterFormItems.ownershipType">
          <mat-form-field>
            <mat-select placeholder="{{ 'school.institution_ownership' | translate }}" [(ngModel)]="filterFormItems.ownershipType" name="ownershipType">
              <mat-option>{{ 'button.all' | translate }}</mat-option>
              <ng-container  *ngIf="filterData.ownerShipType && filterData.ownerShipType.entities">
                <ng-container *ngFor="let item of filterData.ownerShipType.entities">
                  <mat-option [value]="item.tid.toString()" *ngIf="item.reverseFieldOwnershipTypeNode.count > 0">
                    {{ item.entityLabel }}
                  </mat-option>
                </ng-container>
              </ng-container>
            </mat-select>
          </mat-form-field>
        </div><!--/round-inpuit__wrapper-->
      </div><!--/col-4-->
      <div class="col-5 sm-12">
        <div class="round-input__wrapper" [class.complete]="filterFormItems.investmentMeasure">
          <mat-form-field>
            <mat-select placeholder="{{ 'school.investment_measure' | translate }}" [(ngModel)]="filterFormItems.investmentMeasure" name="investmentMeasure">
              <mat-option>{{ 'button.all' | translate }}</mat-option>
              <ng-container  *ngIf="filterData.investmentMeasure && filterData.investmentMeasure.entities">
                <ng-container *ngFor="let item of filterData.investmentMeasure.entities">
                  <mat-option [value]="item.tid.toString()" *ngIf="item.reverseInvestmentMeasureSubsidyProjectEntity.count > 0">
                    {{ item.entityLabel }}
                  </mat-option>
                </ng-container>
              </ng-container>
            </mat-select>
          </mat-form-field>
        </div><!--/round-inpuit__wrapper-->
      </div><!--/col-4-->
      <div class="col-4 sm-12 align-end flex-end">
        <div class="round-input__wrapper" [class.complete]="filterFormItems.investmentDeadline">
          <mat-form-field>
            <mat-select placeholder="{{ 'school.investment_deadline_year' | translate }}" [(ngModel)]="filterFormItems.investmentDeadline" name="investmentDeadline">
              <mat-option>{{ 'button.all' | translate }}</mat-option>
              <mat-option [value]="item.toString()" *ngFor="let item of filterData.investmentDeadline">
                {{ item }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div><!--/round-inpuit__wrapper-->
        <div class="button-row">
          <button role="button" mat-raised-button color="primary">{{ 'button.search' | translate }}</button>
        </div>
      </div><!--/col-4-->
    </div><!--/row-->
  </div>
</form>

<div class="row-wrapper schools">
  <div class="row">
    <div class="col-12">
      <div class="block padding-block">
        <div class="block__head">
          <div class="block__head__title">{{ 'school.label' | translate | uppercase }}: {{ 'school.support_projects' | translate | uppercase}}</div>
          <div class="block__head__buttons">
            <div class="view-item" (click)="changeView('schools')" attr.aria-label="{{ 'event.list' | translate }}" tabindex="0" [class.active]="view === 'schools'">
              <span class="htm-icon">home</span>
              <div class="title" >{{ 'school.label' | translate }}</div>
            </div>
            <div class="view-item" (click)="changeView('areas')" attr.aria-label="{{ 'event.calendar' | translate }}" tabindex="0" [class.active]="view === 'areas'">
              <span class="htm-icon">location_on</span>
              <div class="title">{{ 'school.municipalities' | translate }}</div>
            </div>
          </div><!--/block__head__buttons-->
        </div><!--/block__hed-->

        <div class="map-wrapper" [class.polygonMap]="polygons">
          <div class="map-loader" *ngIf="loading" >
            <mat-spinner diameter="60"></mat-spinner>
          </div><!--/map-loader-->
          <agm-map (mapReady)="mapReady($event)" maxZoom="16" [styles]="mapOptions.styles">
            <agm-marker-cluster [styles]="mapOptions.clusterStyles" maxZoom="15" *ngIf="data">
              <agm-marker [iconUrl]="mapOptions.icon" *ngFor="let marker of data" [latitude]="parseFloat(marker.lat)"  [longitude]="parseFloat(marker.lon)" >
                <agm-snazzy-info-window [closeWhenOthersOpen]="true" (afterClose)="showFunding(false)" #infoWindow maxHeight="99999">
                  <ng-template>
                    <p class="title">{{ marker.schoolInfo.entityLabel }}</p>
                    
                    <ng-container *ngIf="!infoWindowFunding">
                      <p *ngIf="marker.schoolInfo.fieldRegistrationCode">{{ 'school.register_code' | translate }}: <b>{{ marker.schoolInfo.fieldRegistrationCode }}</b></p>
                      <p *ngIf="marker.schoolInfo.fieldOwnershipType">{{ 'school.ownership' | translate }}: <b>{{ marker.schoolInfo.fieldOwnershipType.entity.entityLabel }}</b></p>
                    </ng-container>
                    <hr />
                    <ng-container *ngIf="!infoWindowFunding">
                        <p>{{ 'school.select_investment_measure_year' | translate }}:</p>
                        <div class="tab-buttons">
                          <ng-container *ngFor="let item of groupYears(marker.schoolInfo.CustomSubsidyProjects)">
                            <button (click)="showFunding(item, infoWindow)">{{ item }} </button>
                          </ng-container>
                        </div><!--/tab-buttons-->
                    </ng-container>

                    <ng-container *ngIf="infoWindowFunding">
                      <a href="javascript:void(0);" (click)="showFunding(false)" class="link">&lt; {{ 'button.back' | translate }}</a>
                      <div class="snazzy-scrollarea">
                        <p>{{ infoWindowFunding }}-{{ 'school.selected_year_investment_measure' | translate }}</p>
                        <ng-container *ngFor="let item of parseInfoWindowMarkerData(marker.schoolInfo.CustomSubsidyProjects)">
                          <ng-container *ngIf="item.year == infoWindowFunding">
                            <p>
                              {{ 'school.investment_measure' | translate }}: <b>{{ item.investmentMeasure.entity.entityLabel }}</b><br />
                              {{ 'school.investment_project' | translate }}: <b>{{ item.investmentProject }}</b><br />
                              {{ 'school.investment_max_amount' | translate }}: <b>{{ item.investmentAmount | currency:"EUR" }}</b><br />
                              {{ 'school.investment_deadline' | translate }}: <b>{{ item.investmentDeadline.unix*1000 | date:"dd.MM.yyyy" }}</b>
                            </p>
                          </ng-container>
                        </ng-container>
                      </div><!--/snazzy-scrollarea-->
                    </ng-container>

                  </ng-template>
                </agm-snazzy-info-window>
              </agm-marker>
            </agm-marker-cluster>

            <agm-data-layer *ngIf="polygons" [geoJson]="polygons" [style]="polygonStyles" (layerClick)="kmlClick($event)">
            </agm-data-layer>

            <ng-container *ngIf="sumWindowStatus">
              <agm-snazzy-info-window [closeWhenOthersOpen]="true" #sumLayer isOpen="sumWindowStatus" [latitude]="sumWindowLat" [longitude]="sumWindowLon" (isOpenChange)="kmlClickStatus($event)" >
                <ng-template>
                  <b>{{ infoLayer.name }}</b><br />
                  {{ infoLayer.sum  | currency:"EUR" }}
                </ng-template>
              </agm-snazzy-info-window>
            </ng-container>
          </agm-map>
          <div class="polygons-toggle" *ngIf="polygons">
            <button (click)="changeLayer('county')" [class.active]="polygonLayer == 'county'">{{ 'school.counties' | translate }}</button>
            <button (click)="changeLayer('kov')" [class.active]="polygonLayer == 'kov'">{{ 'school.municipalities_detailed' | translate }}</button>
          </div>
          <img src="/assets/img/placeholder-50.gif" />
        </div><!--/map-wrapper-->

        <ng-container *ngIf="heatMapRanges.length > 0">
          <div class="mapLegend">
            <div class="mapLegend__block" *ngFor="let item of heatMapRanges">
              <div class="mapLegend__color" [style.background-color]="item.color"></div>
              {{ item.minAmount | legendCurrency:"min" }} - {{ item.maxAmount | legendCurrency:"max" }} â‚¬
            </div>
          </div><!--/map-legend-->
        </ng-container>

        <div class="map-created" *ngIf="polygons">{{ 'school.map_created' | translate }} 06.09.2018</div>

      </div><!--/block-->
    </div><!--/col-12-->
  </div><!--/row-->
</div><!--/row-wrapper-->
