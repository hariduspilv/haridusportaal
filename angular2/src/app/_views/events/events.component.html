<breadcrumbs></breadcrumbs>
<div class="sm-show text-right filter-control">
  <a href="javascript:void(0);" (click)="showFilter = !showFilter">
    <span *ngIf="!showFilter">{{ 'button.filter' | translate }}</span>
    <span *ngIf="showFilter">{{ 'button.filter_close' | translate }}</span>
  </a> 
</div>
<form (submit)="filterSubmit($event)" class="filter-wrapper" *ngIf="showFilter">
  <div class="main-container">
    <div class="row form-first-row" [class.short-filter]="!filterFull">
      <div class="col-4 sm-12 form-col" [class.col-9]="view == 'calendar'" style="padding:0.5rem;">
        <div class="round-input__wrapper" [class.complete]="filterFormItems.title">
          <span class="round-input__title">{{ 'event.filter_name' | translate }}</span>
          <div class="round-input__field-wrapper">
            <input attr.aria-label="{{'filter.info' | translate }}" class="round-input__field" placeholder="{{ 'event.filter_name' | translate }} " [(ngModel)]='filterFormItems.title' name="title" />
          </div>
        </div><!--/round-inpuit__wrapper-->
      </div><!--/col-4-->

      <div class="col-25 sm-12 form-col" *ngIf="view == 'list'">
        <div class="round-input__wrapper" [class.complete]="filterFormItems.dateFrom" [class.error]="checkValidity('dateFrom') && !dateFromFocus">
          <span class="round-input__title">{{ 'time.date_period_from' | translate }}</span>
          <div class="round-input__field-wrapper">
            <input autocomplete="off" id="dateFrom" class="round-input__field"
            placeholder="{{ 'time.date_period_from' | translate }}"
            [matDatepicker]="datepickerFrom"
            [(ngModel)]="filterFormItems.dateFrom"
            (change)="dateminmax()"
            (dateChange)="dateminmax()"
            [max]="maxDate"
            [min]="absMinDate"
            name="dateFrom"
            maxlength="10"
            dateFormatter
            (focus)="dateFromFocus = true"
            (blur)="dateFromFocus = false" />
            <mat-datepicker-toggle class="round-input__clear" matSuffix [for]="datepickerFrom"></mat-datepicker-toggle>
            <mat-datepicker #datepickerFrom></mat-datepicker>
          </div>
          <div class="round-input__error">
            <div class="round-input__error--text error-2 error-sm-12" role="alert" *ngIf="checkValidity('dateFrom') && !dateFromFocus">{{ 'errors.enter_valid_date' | translate }}</div>
          </div>
        </div>
      </div>
      
      <div class="col-25 sm-12 form-col" *ngIf="view == 'list'">
        <div class="round-input__wrapper" [class.complete]="filterFormItems.dateTo" [class.error]="checkValidity('dateTo') && !dateToFocus">
          <span class="round-input__title">{{ 'time.date_period_to' | translate }}</span>
          <div class="round-input__field-wrapper">
            <input autocomplete="off" id="dateTo" class="round-input__field" 
            placeholder="{{ 'time.date_period_to' | translate }}"
            [matDatepicker]="datepickerTo"
            [(ngModel)]="filterFormItems.dateTo"
            (change)="dateminmax()"
            (dateChange)="dateminmax()"
            [min]="minDate"
            [max]="absMaxDate"
            name="dateTo"
            maxlength="10"
            dateFormatter 
            (focus)="dateToFocus = true"
            (blur)="dateToFocus = false" />
            <mat-datepicker-toggle class="round-input__clear" matSuffix [for]="datepickerTo"></mat-datepicker-toggle>
            <mat-datepicker #datepickerTo></mat-datepicker>
          </div>
          <div class="round-input__error">
            <div class="round-input__error--text error-2 error-sm-12" role="alert" *ngIf="checkValidity('dateTo') && !dateToFocus">{{ 'errors.enter_valid_date' | translate }}</div>
          </div>
        </div>
      </div>

      <div class="col-3 align-end text-right sm-12 inline-flex form-col" *ngIf="!filterFull">
        <div class="align-center filter-state sm-hide">       
          <a role="button" class="pointer" (click)="filterFull = !filterFull" aria-expanded="false">
            <span>{{ 'button.search_detailed' | translate }}</span>
          </a>
        </div>
        <div class="button-row">
          <button mat-raised-button color="primary">{{ 'button.search' | translate}}</button>
        </div>
      </div><!--/col-3-->
    </div><!--/row-->

    <div class="row form-additional-row" *ngIf="filterFull">
      <div class="col-9 sm-12 form-col">

        <div class="ng-select__wrapper__mt">
          <span class="ng-select__title" [class.exists]="filterFormItems.types && filterFormItems.types.length">{{ 'event.filter_types' | translate}}</span>
          <ng-select
          tabindex="0"
          role="select"
          attr.aria-label="{{'filter.select' | translate}}"
          [class.exists]="filterFormItems.types && filterFormItems.types.length"
          [items]="eventsTypesObs | async"
          [multiple]="true"
          [loading]="loading"
          bindLabel="name"

          name="types"
          [(ngModel)]="filterFormItems.types"
          placeholder="{{ 'event.filter_types' | translate }}"
          (clear)="clearField('types')"
          [dropdownPosition]="'bottom'"></ng-select>      
        </div>
        
      </div>
    </div>
    <div class="row form-additional-row" *ngIf="filterFull">
      <div class="col-9 sm-12 form-col">
        <div class="ng-select__wrapper__mt">
          <span class="ng-select__title"  [class.exists]="filterFormItems.tags && filterFormItems.tags.length">{{ 'event.filter_tags' | translate}}</span>
          <ng-select
          tabindex="0"
          role="select"
           attr.aria-label="{{'filter.select' | translate}}"
          [class.exists]="filterFormItems.tags && filterFormItems.tags.length"
          [items]="eventsTagsObs | async"
          [multiple]="true"
          [loading]="loading"
          bindLabel="name"
          placeholder="{{ 'event.filter_tags' | translate }}"
          (clear)="clearField('tags')"
          [(ngModel)]="filterFormItems.tags"
          name="labels"
          [dropdownPosition]="'bottom'"></ng-select>
        </div>
      </div>
      <div class="col-3 align-end text-right sm-12 inline-flex form-col">
        <div class="align-center filter-state sm-hide">       
          <a role="button" class="btn-link pointer" (click)="filterFull = !filterFull" aria-expanded="true">
            <span>{{ 'button.search_brief' | translate}}</span>
          </a>
        </div>
        <div class="button-row">
          <button role="button" mat-raised-button color="primary">{{ 'button.search' | translate}}</button>
        </div>
      </div><!--/col-3-->
    </div><!--/row-->
  </div>
</form>
<div class="events main-container">
  <div class="events__list-head">
    <div class="events__head">
      <div class="events__title text-left">{{ 'event.label' | translate | uppercase }}</div>
      <div class="button-list text-right sm-hide">
        <div class="view-item pointer" (keyup.enter)="changeView('list')" (click)="changeView('list')" attr.aria-label="{{ 'event.list' | translate }}" tabindex="0" [class.active]="view === 'list'">
          <span class="htm-icon">list</span>
          <div class="title" >{{ 'school.list' | translate }}</div>
        </div>
        <div class="view-item pointer" (keyup.enter)="changeView('calendar')" (click)="changeView('calendar')" attr.aria-label="{{ 'event.calendar' | translate }}" tabindex="0" [class.active]="view === 'calendar'">
          <span class="htm-icon">today</span>
          <div class="title">{{ 'event.calendar' | translate }}</div>
        </div>
      </div><!--/button-list-->
    </div>
  </div><!--/row-->

  <mat-spinner *ngIf="!eventList && !error && view !== 'calendar'" style="margin-top:3rem; position: relative; bottom: 1.5rem;"></mat-spinner>

  <div class="events__list-body" *ngIf="eventList && view == 'list' ">
  
    <ng-container *ngFor="let yearKey of objectKeys(eventList)">
      <ng-container *ngFor="let monthKey of objectKeys(eventList[yearKey])">

        <div class="events__month">
          <h1>{{ 'time.' + getMonthName(monthKey) | translate }}
            <ng-container *ngIf="parseInt(yearKey) !== current.year">
              - {{ yearKey }}
            </ng-container>
          </h1>
        </div>

        <ng-container *ngFor="let dayKey of objectKeys( eventList[yearKey][monthKey] )">
          <div class="events__header center" [class.highlighted]="yearKey == current.year && monthKey == current.month && dayKey == current.day">
            <div class="events__datetime">
              <div class="day">{{ 'time.' +getDayName( dayKey ) | translate }}</div>
              <div class="date">{{ formatNumber(dayKey) }}.{{ formatNumber(monthKey) }}</div>
            </div>
            <div class="events__separator w-100">
              <div class="border"></div>
              <div class="dot"></div>
            </div>
          </div><!--/events__header-->

          <div>
            <ng-container *ngFor="let event of eventList[yearKey][monthKey][dayKey]; let first = first; let last = last">
              <div class="events__block">
                <div class="events__content">
             <div class="title"><a href="javascript:void();" [routerLink]="event.entityUrl.path"><h1>{{ event.title }}</h1></a></div>
                  <div class="sm-show info">
                    <span>{{ event.firstEventTime | unixToTime }}</span>
                    <span>{{ event.location ? event.location.name : '' }}</span>
                  </div>
                  <div class="sm-hide info info-bar">

                    <span class="time">{{ 'event.start_time' | translate }}: <strong>{{ event.firstEventTime | unixToTime }}</strong> </span>

                    <span class="location" *ngIf="event.location">{{ 'event.location' | translate }}: <strong>{{ event.location ? event.location.name : '' }}</strong></span>
                    <span class="entrance" *ngIf="event.fieldEntryType">{{ 'event.entrance' | translate }}: <strong>{{ 'event.' + event.fieldEntryType | translate }}</strong></span>
                  </div>
                  <div class="tags sm-hide" *ngIf="(event.hashTags && event.hashTags.length) || event.fieldEventType">
                    <mat-chip-list tabindex="0" aria-multiselectable="true" >
                      <span *ngIf="event.fieldEventType">
                        <span class="mat-chip-wrapper">
                          <mat-chip >{{ event.fieldEventType.entity.entityLabel }}</mat-chip>
                        </span>
                      </span>
                      <span *ngFor="let eventTag of event.hashTags">
                        <span *ngIf="eventTag.entity" class="mat-chip-wrapper">
                          <mat-chip>{{ eventTag.entity.entityLabel }}</mat-chip>
                        </span>
                      </span>
                    </mat-chip-list>
                  </div><!--/row-->
                </div>
              </div>
            </ng-container><!--/event repeat-->
          </div>
        </ng-container><!--/day repeat-->
      </ng-container><!--/month repeat-->
    </ng-container><!--/year repeat-->

    <div class="text-center actions" *ngIf="!listEnd && view !== 'calendar'">
      <button mat-raised-button color="primary" (click)="loadMore()" role="button" tabindex="0">{{ 'button.load_more' | translate }}</button>
    </div><!--/text-center-->
    <div class="text-center actions__error" *ngIf="eventList != null && objectKeys(eventList).length == 0 && eventList">
      <p role="alert">{{ 'events.no_results' | translate }}</p>
    </div><!--/text-center-->
  </div><!--/ngIf-->

  <div class="calendar__elem" *ngIf="view == 'calendar'">

    <div class="navigation text-center">
      <span tabindex="0" (keyup.enter)="changeMonth(-1);" attr.aria-label="{{'month.prev' | translate}}">
        <span class="icon-wrapper">
          <span class="pointer htm-icon" (click)="changeMonth(-1);">chevron_left</span>
        </span>
      </span>
      <span class="month"><h1 tabindex="0">{{ 'time.' + monthName | lowercase | translate }} <ng-container *ngIf="year !== current.year">{{ year }}</ng-container></h1></span>
      <span  tabindex="0" (keyup.enter)="changeMonth(1);" attr.aria-label="{{'month.next' | translate}}">
        <span class="icon-wrapper">
          <span class="htm-icon pointer" (click)="changeMonth(1);">chevron_right</span>
        </span>
      </span>
    </div><!--/text-center-->
    


    <mat-spinner *ngIf="loadingCalendar" style="margin-top:3rem; position: relative; bottom: 1.5rem;"></mat-spinner>



    <table class="calendar" *ngIf="!loadingCalendar">
      <tr>
        <th width="14.2%" tabindex="-1">{{ 'time.monday' | translate }}</th>
        <th width="14.2%" tabindex="-1">{{ 'time.tuesday' | translate }}</th>
        <th width="14.2%" tabindex="-1">{{ 'time.wednesday' | translate }}</th>
        <th width="14.2%" tabindex="-1">{{ 'time.thursday' | translate }}</th>
        <th width="14.2%" tabindex="-1">{{ 'time.friday' | translate }}</th>
        <th width="14.2%" tabindex="-1">{{ 'time.saturday' | translate }}</th>
        <th width="14.2%" tabindex="-1">{{ 'time.sunday' | translate }}</th>
      </tr>
      <tr *ngFor="let week of calendarDays; let firstWeek = first; let weekNumber = index">
        <td *ngFor="let day of week; let last = last; let weekDayIndex = index" [class.today]="day.i == current.day && month == current.month && year == current.year" [class.disableMore]="morePopup === day" [class.firstTwo]="weekDayIndex < 2" [ngClass]="{ 'lastWeek': weekNumber == calendarDays.length-1, 'almostLastWeek' : weekNumber == calendarDays.length-2}">

          <div class="cal__day more__hidden" tabindex="0">{{ day.i }}</div>

          <div class="cal__event pointer more__hidden" *ngFor="let event of parseDay( day ); let i = index">

            <ng-container *ngIf="i < maxEntries(day)">

              <a href="javascript:void(0)" attr.title="{{ event.title }}" class="content" role="button" [class.active]="popup === event.nid" (click)="togglePopup(event.nid)" (keyup.enter)="togglePopup(event.nid)" (keyup.esc)="popup = null" tabindex="0">
                <span><div class="marker"></div></span>
                <span class="content__medium">{{ event.fieldEventMainStartTime | unixToTime }}</span>
                <span class="content__strong">{{ event.title }}</span>
              </a>
            </ng-container>
            
            <ng-container *ngIf="popup === event.nid">
              <div class="popup" [class.holdRight]="weekDayIndex < 4" [class.holdLeft]="weekDayIndex >= 4" attr.aria-label="{{'modal'}}" aria-modal="true" role="dialog" (keyup.esc)="popup = null">
                <div class="popupcontent">
                  <div class="event__header">

                    <div class="title">
                      <span class="title__strong" >{{ event.title }}</span>

                      <div class="title__close" role="close">
                        <span class="htm-icon">close
                          <button class="btn-hidden pointer" id="firstClose" (click)="closePopup()" attr.aria-label="{{'modal.close' | translate}}"></button>
                        </span>
                      </div>
                    </div>
                  </div>
                    <div class="event__block">
                    
                    <div><span>{{ 'time.date' | translate }}: </span>{{ day.i }}. {{'time.'+monthName | lowercase | translate}}</div>
                    <div role="none" *ngIf="event.eventDates"><span>{{ 'event.start_time' | translate }}: </span>{{ event.fieldEventMainStartTime | unixToTime }}</div>
                    <div *ngIf="event.location"><span>{{ 'event.location' | translate }}: </span>{{ event.location ? event.location.name : '' }}</div>
                    <div *ngIf="event.fieldEntryType"><span>{{ 'event.entrance' | translate }}: </span>{{ 'event.' + event.fieldEntryType | translate}}</div>
                  </div>
                  <div class="line"></div>
                  <div class="event__more"><a href="javascript:void(0)" (blur)="trapFocus('firstClose')" [routerLink]="event.entityUrl.path" tabindex="0">{{'button.view_more' | translate}}</a></div>
                </div>
              </div>
            </ng-container>
          </div>

          <div class="cal__event__more" *ngIf="day.events && day.events.length > maxEntries(day)">
            <div class="more more__hidden"><a href="javascript:void(0)" (click)="toggleMore(day)" >{{ day.events.length - maxEntries(day) }} veel</a></div>
          </div>

          <div class="popup" *ngIf="morePopup === day">
            <div class="popupcontent additional" (keyup.esc)="popup = null">
              <div class="event__block event__block__more">
                <div class="title">
                  <div class="header">
                    <div class="header__medium">{{ 'time.' + getDayName(day.i) | translate }}</div>

                    <div class="header__strong">{{day.i}}. {{ 'time.'+ monthName | lowercase | translate}}</div>

                  </div>
                  <span class="close more"><a href="javascript:void(0)" class="pointer" id="secondClose" (click)="closeMore()"><span class="htm-icon">close</span></a></span>
                </div>
                <div class="popup__scroll">
                  <ng-container *ngFor="let event of parseDay( day ); let i = index;">
                    <a href="javascript:void(0)" (blur)="trapFocus('secondClose')" class="cal__event pointer" [routerLink]="event.entityUrl.path">
                      <div class="content content__more">
                        <span><div class="marker"></div></span>
                        <span class="content__medium">{{ event.fieldEventMainStartTime | unixToTime }}</span>
                        <span class="content__strong">{{ event.title }}</span>
                      </div>
                    </a>
                  </ng-container>
                </div><!--/popup__scroll-->
              </div>
            </div>
          </div>

        </td>
      </tr>
    </table>
  </div><!--/view content-->
</div>


